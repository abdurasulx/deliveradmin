{% load static %}
<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yetkazib beruvchi paneli</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }

    /* === Sidebar === */
    .sidebar {
      height: 100vh;
      width: 240px;
      position: fixed;
      left: 0;
      top: 0;
      background: #0d6efd;
      color: #fff;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    .sidebar h4 {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      text-align: center;
    }
    .sidebar a {
      padding: 15px 20px;
      text-decoration: none;
      color: white;
      display: block;
    }
    .sidebar a:hover, .sidebar a.active {
      background: rgba(255,255,255,0.2);
    }

    /* === Content === */
    .content {
      margin-left: 240px;
      padding: 20px;
      transition: all 0.3s ease;
    }
    .hidden { display: none; }

    .order-card {
      border: 1px solid #dee2e6;
      border-left: 5px solid #0d6efd;
      border-radius: 6px;
      background: #fff;
      margin-bottom: 15px;
      padding: 15px;
      transition: all 0.3s ease;
    }
    .order-card.delivered { border-left-color: #198754; background: #e9f9ee; }
    .order-card.canceled { border-left-color: #dc3545; background: #fdeaea; }

    .footer {
      text-align: center;
      padding: 15px;
      font-size: 14px;
      color: gray;
      border-top: 1px solid #dee2e6;
      margin-top: 40px;
    }

    @media (max-width: 992px) {
      .sidebar { left: -240px; }
      .sidebar.show { left: 0; }
      .content { margin-left: 0; padding: 15px; }
      .toggle-btn { display: inline-block; }
    }
    @media (min-width: 993px) { .toggle-btn { display: none; } }
  </style>
</head>
<body>

<!-- === Sidebar === -->
<div class="sidebar" id="sidebar">
  <h4>üöö Yetkazib beruvchi</h4>
  <a href="#" class="menu-link active" data-page="home">Bosh sahifa</a>
  <a href="#" class="menu-link" data-page="orders">Buyurtmalar</a>
  <a href="#" class="menu-link" data-page="profile">Profil</a>
  <a href="{% url 'logout' %}" class="text-danger mt-auto p-3">üö™ Chiqish</a>
</div>

<!-- === Content === -->
<div class="content">
  <nav class="navbar navbar-light bg-white mb-3 shadow-sm rounded d-flex justify-content-between align-items-center">
    <button class="btn btn-outline-primary toggle-btn" id="toggleSidebar">‚ò∞</button>
    <span class="navbar-brand mb-0 h5">üëã Salom, {{ request.user.first_name }}!</span>
  </nav>

  <!-- Bosh sahifa -->
  <div id="home-page">
    <h3>Bosh sahifa</h3>
    <hr>
    <div class="row g-3">
      <div class="col-md-4">
        <div class="card shadow-sm text-center"><div class="card-body"><h5>üì¶ Faol</h5><h3>{{ active_orders_count }}</h3></div></div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm text-center"><div class="card-body"><h5>‚úÖ Yetkazilgan</h5><h3>{{ delivered_orders_count }}</h3></div></div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm text-center"><div class="card-body"><h5>‚ùå Bekor qilingan</h5><h3>{{ canceled_orders_count }}</h3></div></div>
      </div>
    </div>
  </div>

  <!-- Buyurtmalar -->
  <div id="orders-page" class="hidden">
    <h3>Buyurtmalar</h3>
    <hr>

    <h5 class="text-primary">üöö Yetkazilayotganlar</h5>
    <div id="delivering-orders">
      {% for order in delivering_orders %}
      <div class="order-card" id="order-{{ order.id }}">
        <h6><b>{{ order.customer_name }}</b> ‚Äî {{ order.delivery_address }}</h6>
        <p>{{ order.total_price }} so‚Äòm | {{ order.created_at|date:"d.m.Y H:i" }}</p>
        <span class="badge bg-warning text-dark">Yetkazilmoqda</span>
        <div class="mt-2">
          <button class="btn btn-success btn-sm deliver-btn w-100" data-id="{{ order.id }}">‚úÖ Topshirish</button>
        </div>
      </div>
      {% empty %}
        <p>Hozircha faol buyurtmalar yo‚Äòq.</p>
      {% endfor %}
    </div>

    <h5 class="text-success mt-4">‚úÖ Yetkazib berilganlar</h5>
    <div id="delivered-orders">
      {% for order in delivered_orders %}
      <div class="order-card delivered">
        <h6><b>{{ order.customer_name }}</b> ‚Äî {{ order.address }}</h6>
        <p>{{ order.total_price }} so‚Äòm | {{ order.updated_at|date:"d.m.Y H:i" }}</p>
        <span class="badge bg-success">Yetkazib berilgan</span>
      </div>
      {% empty %}
        <p>Hali topshirilgan buyurtmalar yo‚Äòq.</p>
      {% endfor %}
    </div>

    <h5 class="text-danger mt-4">‚ùå Bekor qilinganlar</h5> 
    {% for order in canceled_orders %}
      <div class="order-card canceled">
        <h6><b>{{ order.customer_name }}</b> ‚Äî {{ order.address }}</h6>
        <p>{{ order.total_price }} so‚Äòm | {{ order.updated_at|date:"d.m.Y H:i" }}</p>
        <span class="badge bg-danger">Bekor qilingan</span>
      </div>
    {% empty %}
      <p>Bekor qilingan buyurtmalar mavjud emas.</p>
    {% endfor %}
  </div>

  <!-- Profil -->
  <div id="profile-page" class="hidden">
    <h3>Profil</h3>
    <hr>
    <div class="card shadow-sm p-3 mb-3">
      <p><b>Ism:</b> {{ request.user.first_name }}</p>
      <p><b>Familiya:</b> {{ request.user.last_name }}</p>
      <p><b>Login:</b> {{ request.user.username }}</p>
      <p><b>Email:</b> {{ request.user.email }} {{ deliver.id }} </p>
    </div>
    <a href="{% url 'logout' %}" class="btn btn-danger w-100">üö™ Chiqish</a>
  </div>

  <div class="footer">¬© {{ now|date:"Y" }} Yetkazib beruvchi tizimi</div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Sidebar toggle
document.getElementById('toggleSidebar').addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('show');
});

// Navigatsiya
document.querySelectorAll('.menu-link').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
    link.classList.add('active');
    const page = link.dataset.page;
    document.querySelectorAll('#home-page, #orders-page, #profile-page').forEach(p => p.classList.add('hidden'));
    document.getElementById(`${page}-page`).classList.remove('hidden');
  });
});

// ‚úÖ AJAX bilan topshirish
document.querySelectorAll('.deliver-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const orderId = btn.dataset.id;
    try {
      const res = await fetch('/update_order_status/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ order_id: orderId, status: 'accepted' })
      });
      const data = await res.json();

      if (data.success) {
        const card = document.getElementById(`order-${orderId}`);
        card.classList.add('delivered');
        card.querySelector('.badge').classList.remove('bg-warning', 'text-dark');
        card.querySelector('.badge').classList.add('bg-success');
        card.querySelector('.badge').textContent = 'Yetkazib berilgan';
        card.querySelector('.mt-2').remove();

        document.getElementById('delivered-orders').prepend(card);
      } else {
        alert("Xatolik: " + data.error);
      }
    } catch (err) {
      console.error("Xato:", err);
    }
  });
});
</script>


<script>
// ‚úÖ Har 1 soniyada buyurtmalarni yangilash
async function fetchOrders() {
  let delid={{ deliver.id }};
  try {
    const res = await fetch(`/api/orders/${delid}/`);
    const data = await res.json();
    console.log(data);

    // API formatini tekshirib olamiz
    if (!Array.isArray(data)) return;

    const deliveringContainer = document.getElementById('delivering-orders');
    const deliveredContainer = document.getElementById('delivered-orders');

    deliveringContainer.innerHTML = '';
    deliveredContainer.innerHTML = '';

    // Har bir buyurtmani DOM‚Äôga joylash
    data.forEach(order => {
      const card = document.createElement('div');
      card.classList.add('order-card');
      card.id = `order-${order.id}`;

      const name = order.orderlist__customer_name || 'Noma ºlum mijoz';
      const address = order.delivery_address || 'Manzil kiritilmagan';
      const date = new Date(order.created_at).toLocaleString('uz-UZ');

      if ( order.status === 'submitted') {
        // üöö Yetkazilayotgan buyurtmalar
        card.innerHTML = `
          <h6><b>${name}</b> ‚Äî ${address}</h6>
          <p>${date}</p>
          <span class="badge bg-warning text-dark">Yetkazilmoqda</span>
          <div class="mt-2">
            <button class="btn btn-success btn-sm deliver-btn w-100" data-id="${order.id}">
              ‚úÖ Topshirish
            </button>
          </div>
        `;
        deliveringContainer.appendChild(card);
      } 
      else if (order.status === 'accepted') {
        // ‚úÖ Yetkazib berilgan buyurtmalar
        card.classList.add('delivered');
        card.innerHTML = `
          <h6><b>${name}</b> ‚Äî ${address}</h6>
          <p>${date}</p>
          <span class="badge bg-success">Yetkazib berilgan</span>
        `;
        deliveredContainer.appendChild(card);
      }
    });

    // Yangilangan elementlarga event ulang
    addDeliverButtonListeners();

  } catch (err) {
    console.error("Buyurtmalarni yuklashda xato:", err);
  }
}

// ‚úÖ Har 1 sekundda avtomatik chaqirish
setInterval(fetchOrders, 1000);

// ‚úÖ Tugmalarni qayta ulash funksiyasi
function addDeliverButtonListeners() {
  document.querySelectorAll('.deliver-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const orderId = btn.dataset.id;
      try {
        const res = await fetch('/update_order_status/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ order_id: orderId, status: 'accepted' })
        });
        const data = await res.json();

        if (data.success) {
          const card = document.getElementById(`order-${orderId}`);
          card.classList.add('delivered');
          card.querySelector('.badge').classList.remove('bg-warning', 'text-dark');
          card.querySelector('.badge').classList.add('bg-success');
          card.querySelector('.badge').textContent = 'Yetkazib berilgan';
          card.querySelector('.mt-2')?.remove();

          document.getElementById('delivered-orders').prepend(card);
        } else {
          alert("Xatolik: " + data.error);
        }
      } catch (err) {
        console.error("Xato:", err);
      }
    });
  });
}
</script>

</body>
</html>
