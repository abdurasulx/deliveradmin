<table class="table table-bordered align-middle">
  <thead class="table-{{ color }}">
    <tr>
      <th>#</th>
      {% if orders and orders.status != "pending" %}
        <th>Yetkazib beruvchi</th>
      {% endif %}
      <th>Mijoz</th>
      <th>Manzil</th>
      <th>Mahsulotlar</th>
      <th>Status</th>
      <th>Sana</th>
      <th>Amal</th>
    </tr>
  </thead>
  <tbody>
    {% for order in orders %}
    <tr>
      <td>{{ forloop.counter }}</td>

      {% if order.status != 'pending'  %}
        <td>{{ order.deliver.user.first_name }} {{ order.deliver.user.last_name }}</td>
      {% elif order.status != 'pending' %}
        <td><span class="text-muted">Biriktirilmagan</span></td>
      {% endif %}

      <td>{{ order.client.first_name }} {{ order.client.last_name }}</td>
      <td>{{ order.delivery_address }}</td>
      <td>Hot dog</td>

      <td>
        {% if order.status == 'pending' %}
          <span class="badge bg-warning">Yuklanmoqda</span>
        {% elif order.status == 'submitted' %}
          <span class="badge bg-primary">Topshirilgan</span>
        {% elif order.status == 'accepted' %}
          <span class="badge bg-success">Qabul qilingan</span>
        {% elif order.status == 'rejected' %}
          <span class="badge bg-danger">Bekor qilingan</span>
        {% endif %}
      </td>

      <td>{{ order.created_at|date:"d-m-Y H:i" }}</td>

      <td>
        {% if order.status == 'pending' %}
          <!-- Topshirish tugmasi -->
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal"
                  data-bs-target="#assignDeliverModal"
                  data-order-id="{{ order.id }}">
            ğŸšš Topshirish
          </button>
        {% elif order.status == 'submitted' %}
          <span class="text-primary">âœ… Topshirilgan</span>
        {% elif order.status == 'accepted' %}
          <span class="text-success">ğŸŸ¢ Qabul qilingan</span>
        {% elif order.status == 'rejected' %}
          <span class="text-danger">âŒ Bekor qilingan</span>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="8" class="text-center text-muted py-3">Buyurtmalar mavjud emas.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ğŸšš Yetkazib beruvchini tanlash modali -->
<div class="modal fade" id="assignDeliverModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="assignDeliverForm" method="POST">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yetkazib beruvchini tanlash</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Yopish"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="order_id" id="modalOrderId">
          <div class="mb-3">
            <label class="form-label">Yetkazib beruvchi:</label>
            <select name="deliver_id" class="form-select" required>
              <option value="">Tanlang...</option>
              {% for d in delivers %}
                <option value="{{ d.id }}">{{ d.user.first_name }} {{ d.user.last_name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
          <button type="submit" class="btn btn-primary">Topshirish</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('assignDeliverModal');
  const orderIdInput = document.getElementById('modalOrderId');
  const form = document.getElementById('assignDeliverForm');

  modal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const orderId = button.getAttribute('data-order-id');
    orderIdInput.value = orderId;
  });

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    fetch("{% url 'assign_deliver' %}", {
      method: 'POST',
      body: formData,
      headers: {'X-Requested-With': 'XMLHttpRequest'},
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || "Xatolik yuz berdi!");
      }
    });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('assignDeliverModal');
  const orderIdInput = document.getElementById('modalOrderId');
  const form = document.getElementById('assignDeliverForm');

  // ğŸ”„ Jadvalni real vaqtda yangilovchi funksiya
  function fetchOrders() {
    fetch("{% url 'all_orders_api' %}")
      .then(response => response.json())
      .then(data => {
        const pendingTbody = document.querySelector('#pending tbody');
        const submittedTbody = document.querySelector('#submitted tbody');
        const acceptedTbody = document.querySelector('#accepted tbody');
        const rejectedTbody = document.querySelector('#rejected tbody');

        // ğŸ”„ tozalash
        [pendingTbody, submittedTbody, acceptedTbody, rejectedTbody].forEach(tbody => {
          if (tbody) tbody.innerHTML = '';
        });

        // ğŸ” har bir buyurtmani toifasiga qarab joylashtirish
        data.forEach((order, index) => {
          const created = new Date(order.created_at);
          const dateStr = created.toLocaleString('uz-UZ', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
          });

          let statusBadge = '';
          let action = '';
          let deliverCell = order.deliver_name || '<span class="text-muted">Biriktirilmagan</span>';

          if (order.status === 'pending') {
            statusBadge = `<span class="badge bg-warning">Yuklanmoqda</span>`;
            action = `
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal"
                      data-bs-target="#assignDeliverModal"
                      data-order-id="${order.id}">
                ğŸšš Topshirish
              </button>`;
          } else if (order.status === 'submitted') {
            statusBadge = `<span class="badge bg-primary">Topshirilgan</span>`;
            action = `<span class="text-primary">âœ… Topshirilgan</span>`;
          } else if (order.status === 'accepted') {
            statusBadge = `<span class="badge bg-success">Qabul qilingan</span>`;
            action = `<span class="text-success">ğŸŸ¢ Qabul qilingan</span>`;
          } else if (order.status === 'rejected') {
            statusBadge = `<span class="badge bg-danger">Bekor qilingan</span>`;
            action = `<span class="text-danger">âŒ Bekor qilingan</span>`;
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${deliverCell}</td>
            <td>${order.client_name}</td>
            <td>${order.delivery_address}</td>
            <td>${order.product_name || 'Hot dog'}</td>
            <td>${statusBadge}</td>
            <td>${dateStr}</td>
            <td>${action}</td>
          `;

          // kerakli boâ€˜limga joylashtirish
          if (order.status === 'pending' && pendingTbody)
            pendingTbody.appendChild(tr);
          else if (order.status === 'submitted' && submittedTbody)
            submittedTbody.appendChild(tr);
          else if (order.status === 'accepted' && acceptedTbody)
            acceptedTbody.appendChild(tr);
          else if (order.status === 'rejected' && rejectedTbody)
            rejectedTbody.appendChild(tr);
        });

        // agar boâ€˜sh boâ€˜lsa, â€œboâ€˜shâ€ xabarini chiqarish
        function showEmpty(tbody, text) {
          if (tbody && tbody.children.length === 0)
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-3">${text}</td></tr>`;
        }

        showEmpty(pendingTbody, "Yuklanayotgan buyurtmalar mavjud emas.");
        showEmpty(submittedTbody, "Topshirilgan buyurtmalar mavjud emas.");
        showEmpty(acceptedTbody, "Qabul qilingan buyurtmalar mavjud emas.");
        showEmpty(rejectedTbody, "Bekor qilingan buyurtmalar mavjud emas.");
      })
      .catch(err => console.error("Fetch error:", err));
  }

  // ğŸ” Har 2 sekundda yangilash
  fetchOrders();
  setInterval(fetchOrders, 2000);

  // ğŸšš Modal koâ€˜rsatish
  modal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const orderId = button.getAttribute('data-order-id');
    orderIdInput.value = orderId;
  });

  // ğŸ“¨ Yetkazib beruvchini biriktirish
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    fetch("{% url 'assign_deliver' %}", {
      method: 'POST',
      body: formData,
      headers: {'X-Requested-With': 'XMLHttpRequest'},
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        fetchOrders(); // Jadvalni yangilash
        modal.querySelector('.btn-close').click();
      } else {
        alert(data.error || "Xatolik yuz berdi!");
      }
    });
  });
});
</script>

